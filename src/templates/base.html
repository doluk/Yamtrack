{% load static %}
{% load app_tags %}

<!DOCTYPE html>
<html lang="en" class="scheme-dark bg-[#212529]">
  <head>
    {# Required meta tags #}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="Yamtrack, Media Tracker">
    <meta name="description" content="Search and track media on Yamtrack.">

    <title>
      {% block title %}
        Yamtrack
      {% endblock title %}
    </title>

    <link rel="stylesheet" type="text/css" href="{% static "css/main.css" %}" />

    {% block extra_head %}
    {% endblock extra_head %}

    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script defer
            src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/lazysizes@5.3.2/lazysizes.min.js" async></script>

    <link rel="apple-touch-icon"
          sizes="180x180"
          href="{% static "favicon/apple-touch-icon.png" %}">
    <link rel="icon"
          type="image/png"
          sizes="32x32"
          href="{% static "favicon/favicon-32x32.png" %}">
    <link rel="icon"
          type="image/png"
          sizes="16x16"
          href="{% static "favicon/favicon-16x16.png" %}">
    <link rel="manifest" href="{% static "favicon/site.webmanifest" %}">
    <link rel="mask-icon"
          href="{% static "favicon/safari-pinned-tab.svg" color="#181a1b" %}">
    <link rel="shortcut icon" href="{% static "favicon/favicon.ico" %}">
    <meta name="msapplication-TileColor" content="#181a1b">
    <meta name="msapplication-config"
          content="{% static "favicon/browserconfig.xml" %}">
    <meta name="theme-color" content="#181a1b">

  </head>

  <body>
    {% block body %}
      {# Main container for the layout #}
      <div class="flex min-h-screen bg-[#212529] text-gray-100"
           x-data="{ isMobileMenuOpen: false }">

        {# Mobile menu overlay #}
        <div x-show="isMobileMenuOpen"
             class="fixed inset-0 bg-black/50 z-30 lg:hidden"
             @click="isMobileMenuOpen = false"></div>

        {# Sidebar #}
        <aside class="fixed top-0 left-0 z-40 h-screen w-64 bg-[#1a1d20] transform transition-transform duration-300 ease-in-out border-r border-[#2c3136] -translate-x-full lg:translate-x-0 lg:sticky"
               :class="isMobileMenuOpen ? 'translate-x-0' : ''">
          <div class="h-16 border-b border-[#2c3136] flex items-center px-6">
            <h1 class="text-2xl font-semibold text-gray-100">Yamtrack</h1>
          </div>
          <nav class="p-4">
            <ul class="space-y-1 mb-6">
              <li>
                <a href="{% url 'home' %}"
                   class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if request.path == "/" %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                  {% icon 'home' is_active=request.path|str_equals:"/" %}
                  <span>Home</span>
                </a>
              </li>

              {% if request.user.tv_enabled %}
                <li>
                  <a href="{% url 'medialist' media_type='tv' %}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if media_type == 'tv' %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% icon 'tv' is_active=media_type|str_equals:"tv" %}
                    <span>{{ "tv"|media_type_readable_plural }}</span>
                  </a>
                </li>
              {% endif %}

              {% if request.user.season_enabled %}
                <li>
                  <a href="{% url 'medialist' media_type='season' %}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if media_type == 'season' %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% icon 'season' is_active=media_type|str_equals:"season" %}
                    <span>{{ "season"|media_type_readable_plural }}</span>
                  </a>
                </li>
              {% endif %}

              {% if request.user.movie_enabled %}
                <li>
                  <a href="{% url 'medialist' media_type='movie' %}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if media_type == 'movie' %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% icon 'movie' is_active=media_type|str_equals:"movie" %}
                    <span>{{ "movie"|media_type_readable_plural }}</span>
                  </a>
                </li>
              {% endif %}

              {% if request.user.anime_enabled %}
                <li>
                  <a href="{% url 'medialist' media_type='anime' %}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if media_type == 'anime' %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% icon 'anime' is_active=media_type|str_equals:"anime" %}
                    <span>{{ "anime"|media_type_readable_plural }}</span>
                  </a>
                </li>
              {% endif %}

              {% if request.user.manga_enabled %}
                <li>
                  <a href="{% url 'medialist' media_type='manga' %}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if media_type == 'manga' %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% icon 'manga' is_active=media_type|str_equals:"manga" %}
                    <span>{{ "manga"|media_type_readable_plural }}</span>
                  </a>
                </li>
              {% endif %}

              {% if request.user.game_enabled %}
                <li>
                  <a href="{% url 'medialist' media_type='game' %}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if media_type == 'game' %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% icon 'game' is_active=media_type|str_equals:"game" %}
                    <span>{{ "game"|media_type_readable_plural }}</span>
                  </a>
                </li>
              {% endif %}

              {% if request.user.book_enabled %}
                <li>
                  <a href="{% url 'medialist' media_type='book' %}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if media_type == 'book' %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% icon 'book' is_active=media_type|str_equals:"book" %}
                    <span>{{ "book"|media_type_readable_plural }}</span>
                  </a>
                </li>
              {% endif %}
            </ul>

            <div class="border-t border-[#2c3136] pt-4">
              <ul class="space-y-1">
                {% url 'create_item' as create_item_url %}
                <li>
                  <a href="{{ create_item_url }}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if request.path == create_item_url %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% icon 'create' is_active=request.path|str_equals:create_item_url %}
                    <span>Create Custom</span>
                  </a>
                </li>

                {% url 'statistics' as statistics %}
                <li>
                  <a href="{{ statistics }}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if request.path == statistics %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% icon 'statistics' is_active=request.path|str_equals:statistics %}
                    <span>Statistics</span>
                  </a>
                </li>

                {% url 'lists' as lists_url %}
                <li>
                  <a href="{{ lists_url }}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if request.path == lists_url %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% icon 'lists' is_active=request.path|str_equals:lists_url %}
                    <span>Custom Lists</span>
                  </a>
                </li>

                {% url 'calendar' as calendar_url %}
                <li>
                  <a href="{{ calendar_url }}"
                     class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if request.path == calendar_url %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
                    {% icon 'calendar' is_active=request.path|str_equals:calendar_url %}
                    <span>Calendar</span>
                  </a>
                </li>
              </ul>
            </div>
          </nav>

          <div class="absolute bottom-4 left-4 right-4">
            {% url 'profile' as profile_url %}
            <a href="{{ profile_url }}"
               class="flex items-center space-x-3 px-4 py-2 rounded-md transition-colors duration-200 text-sm {% if request.path == profile_url %}text-white bg-[#2c3136]{% else %}text-gray-400 hover:text-white hover:bg-[#23272b]{% endif %}">
              {% icon 'profile' is_active=request.path|str_equals:profile_url %}
              <span>Profile</span>
            </a>

            <form method="post" action="{% url 'logout' %}" class="w-full">
              {% csrf_token %}
              <button type="submit"
                      class="w-full flex items-center space-x-3 px-4 py-2 rounded-md text-gray-400 hover:bg-[#23272b] hover:text-white transition-colors duration-200 text-sm cursor-pointer">
                {% icon 'logout' is_active=False %}
                <span>Logout</span>
              </button>
            </form>
          </div>
        </aside>

        {# Main content #}
        <div class="flex-1 flex flex-col min-h-screen">
          {# Top bar #}
          <div class="sticky top-0 z-10 bg-[#1a1d20] border-b border-[#2c3136] shadow-md">
            <div class="container mx-auto px-4">
              <div class="flex items-center justify-between lg:justify-center h-16">
                {# Mobile: sidebar toggle button #}
                <button @click="isMobileMenuOpen = !isMobileMenuOpen"
                        class="lg:hidden pe-3 text-gray-400 hover:text-white transition-colors duration-200">
                  <svg xmlns="http://www.w3.org/2000/svg"
                       width="24"
                       height="24"
                       viewBox="0 0 24 24"
                       fill="none"
                       stroke="currentColor"
                       stroke-width="2"
                       stroke-linecap="round"
                       stroke-linejoin="round"
                       class="w-6 h-6">
                    <line x1="4" x2="20" y1="12" y2="12"></line>
                    <line x1="4" x2="20" y1="6" y2="6"></line>
                    <line x1="4" x2="20" y1="18" y2="18"></line>
                  </svg>
                </button>

                {# Search bar #}
                <div class="relative w-full max-w-2xl">
                  <form method="get" action="{% url 'search' %}" x-data="{ isOpen: false, selectedType: { display: '{{ user.last_search_type|media_type_readable_plural }}', value: '{{ user.last_search_type }}' }, mediaTypes: [
                    {% if not user.hide_from_search or user.tv_enabled %}
                      { display: '{{ "tv"|media_type_readable_plural }}', value: 'tv' },
                    {% endif %}

                    {% if not user.hide_from_search or user.movie_enabled %}
                      { display: '{{ "movie"|media_type_readable_plural }}', value: 'movie' },
                    {% endif %}

                    {% if not user.hide_from_search or user.anime_enabled %}
                      { display: '{{ "anime"|media_type_readable_plural }}', value: 'anime' },
                    {% endif %}

                    {% if not user.hide_from_search or user.manga_enabled %}
                      { display: '{{ "manga"|media_type_readable_plural }}', value: 'manga' },
                    {% endif %}

                    {% if not user.hide_from_search or user.game_enabled %}
                      { display: '{{ "game"|media_type_readable_plural }}', value: 'game' },
                    {% endif %}

                    {% if not user.hide_from_search or user.book_enabled %}
                      { display: '{{ "book"|media_type_readable_plural }}', value: 'book' },
                    {% endif %}
                    ], getPlaceholder() { return `Search ${this.selectedType.display.toLowerCase()}...` } }">
                    <div class="flex">
                      <div class="relative flex-grow">
                        <input type="search"
                               name="q"
                               value="{{ request.GET.q }}"
                               :placeholder="getPlaceholder()"
                               class="w-full py-2 pl-10 pr-4 text-sm text-gray-300 bg-[#23272b] rounded-l-md focus:outline-none focus:ring-2 focus:ring-[#4a9eff] placeholder-gray-500">
                        <button type="submit"
                                class="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition-colors duration-200 focus:outline-none cursor-pointer">
                          <svg xmlns="http://www.w3.org/2000/svg"
                               width="24"
                               height="24"
                               viewBox="0 0 24 24"
                               fill="none"
                               stroke="currentColor"
                               stroke-width="2"
                               stroke-linecap="round"
                               stroke-linejoin="round"
                               class="w-5 h-5">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.3-4.3"></path>
                          </svg>
                        </button>
                      </div>
                      <input type="hidden" name="media_type" :value="selectedType.value">
                      <button type="button"
                              @click="isOpen = !isOpen"
                              @click.away="isOpen = false"
                              class="flex items-center justify-between w-32 px-4 py-2 text-sm text-gray-300 bg-[#23272b] rounded-r-md focus:outline-none focus:ring-2 focus:ring-[#4a9eff] focus:ring-inset hover:bg-[#2a2e33] transition-colors duration-200 cursor-pointer">
                        <span x-text="selectedType.display"></span>
                        <svg class="w-4 h-4 ml-2"
                             fill="none"
                             stroke="currentColor"
                             viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                      </button>
                      <ul x-cloak
                          x-show="isOpen"
                          @keydown.escape.window="isOpen = false"
                          x-transition:enter="transition ease-out duration-100"
                          x-transition:enter-start="transform opacity-0 scale-95"
                          x-transition:enter-end="transform opacity-100 scale-100"
                          x-transition:leave="transition ease-in duration-75"
                          x-transition:leave-start="transform opacity-100 scale-100"
                          x-transition:leave-end="transform opacity-0 scale-95"
                          class="absolute z-20 py-1 mt-12 overflow-auto text-sm text-gray-300 bg-[#2a2e33] rounded-md shadow-lg max-h-60 right-0 w-[128px]">
                        <template x-for="type in mediaTypes" :key="type.value">
                          <li @click="selectedType = type; isOpen = false"
                              class="px-4 py-2 cursor-pointer hover:bg-[#343a40] transition duration-150 ease-in-out"
                              x-text="type.display"></li>
                        </template>
                      </ul>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <main class="flex-1 relative bg-[#212529]">
            <div class="container mx-auto px-4 py-8">
              {% block content %}
              {% endblock content %}

              {% if messages %}
                <div class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 w-full max-w-sm">
                  {% for message in messages %}
                    {# djlint:off #}
                    <div class="flex items-center justify-between gap-4 rounded-lg border px-4 py-3 shadow-lg animate-in slide-in-from-bottom-2 toast-{{ message.tags }}"
                        x-transition:leave="transition ease-in duration-200"
                        x-transition:leave-start="opacity-100"
                        x-transition:leave-end="opacity-0"
                        {% if message.tags not in 'warning,error' %}
                        x-data="{ init() { setTimeout(() => this.$el.remove(), 8000) } }"
                        {% endif %}>
                      <p class="text-sm font-medium">{{ message }}</p>
                      <button class="text-current opacity-70 hover:opacity-100 transition-opacity cursor-pointer"
                              @click="$el.parentElement.remove()">
                        <svg xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round">
                          <path d="M18 6 6 18"></path>
                          <path d="m6 6 12 12"></path>
                        </svg>
                      </button>
                    </div>
                    {# djlint:on #}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </main>
        </div>
      </div>

      {% block js %}
      {% endblock js %}
    {% endblock body %}
  </body>
</html>
