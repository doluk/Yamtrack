{% extends "base.html" %}
{% load static %}
{% load app_tags %}

{% block title %}
  {{ media_type|media_type_readable_plural }} - Yamtrack
{% endblock title %}

{% block content %}
  <h1 class="text-3xl font-bold mb-6">{{ media_type|media_type_readable_plural }}</h1>

  <div x-data="{
    sort: '{{ current_sort }}',
    layout: '{{ current_layout }}',
    search: '{{ request.GET.search|default:'' }}',
    statusLabels: {
      {% for value, label in status_choices %}
        '{{ value }}': '{{ label }}'{% if not forloop.last %},{% endif %}
      {% endfor %}
    },
    sortLabels: {
      {% for value, label in sort_choices %}
        '{{ value }}': '{{ label }}'{% if not forloop.last %},{% endif %}
      {% endfor %}
    }
  }">

    <!-- Form to manage state -->
    <form id="filter-form" class="hidden">
      <input type="hidden" name="sort" x-model="sort">
      <input type="hidden" name="status" x-model="status">
      <input type="hidden" name="search" x-model="search">
      <input type="hidden" name="layout" x-model="layout">
    </form>

    <div class="flex flex-col md:flex-row gap-4 mb-6">
      <!-- Search -->
      <div class="relative flex-grow">
        <input placeholder="Search {{ media_type_plural }}..."
               class="w-full py-2 pl-10 pr-4 bg-[#39404b] rounded-md text-white focus:outline-none focus:ring-2 focus:ring-[#4a9eff] appearance-none"
               type="text"
               x-model="search"
               hx-get="{% url 'medialist' media_type %}"
               hx-trigger="keyup changed delay:300ms, search"
               {% if media_list %} hx-target="{{ layout_class }}" {% else %} hx-target="this" hx-swap="none" {% endif %}
               hx-include="#filter-form"
               hx-indicator="#search-indicator">
        <svg xmlns="http://www.w3.org/2000/svg"
             width="24"
             height="24"
             viewBox="0 0 24 24"
             fill="none"
             stroke="currentColor"
             stroke-width="2"
             stroke-linecap="round"
             stroke-linejoin="round"
             class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.3-4.3"></path>
        </svg>
        <div id="search-indicator"
             class="htmx-indicator absolute right-3 top-1/2 transform -translate-y-1/2">
          <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-indigo-500"></div>
        </div>
      </div>

      <div class="flex gap-2 flex-wrap">
        <!-- Filter by Status -->
        <div class="relative" x-data="{ open: false }">
          <button class="flex items-center px-4 py-2 bg-[#39404b] rounded-md hover:bg-[#454d5a] transition-colors cursor-pointer"
                  @click="open = !open"
                  type="button">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 viewBox="0 0 24 24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round"
                 class="w-4 h-4 mr-2">
              <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
            <span x-text="statusLabels[status] || status"></span>
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 viewBox="0 0 24 24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round"
                 class="w-4 h-4 ml-2">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </button>

          <div class="absolute z-10 mt-2 py-1 w-48 bg-[#39404b] rounded-md shadow-lg overflow-hidden border border-gray-700"
               x-cloak
               x-show="open"
               @click.outside="open = false"
               x-transition:enter="transition ease-out duration-100"
               x-transition:enter-start="transform opacity-0 scale-95"
               x-transition:enter-end="transform opacity-100 scale-100"
               x-transition:leave="transition ease-in duration-75"
               x-transition:leave-start="transform opacity-100 scale-100"
               x-transition:leave-end="transform opacity-0 scale-95">
            <button hx-get="{% url 'medialist' media_type %}"
                    {% if media_list %} hx-target="{{ layout_class }}" {% else %} hx-target="this" hx-swap="none" {% endif %}
                    hx-include="#filter-form"
                    hx-indicator="#loading-indicator"
                    class="block w-full px-4 py-2 text-left text-sm transition-colors cursor-pointer"
                    :class="status === 'all' ? 'bg-indigo-600 text-white font-medium' : 'text-gray-300 hover:bg-[#454d5a] hover:text-white'"
                    @click="status = 'all'; open = false"
                    type="button">All</button>
            <button hx-get="{% url 'medialist' media_type %}"
                    {% if media_list %} hx-target="{{ layout_class }}" {% else %} hx-target="this" hx-swap="none" {% endif %}
                    hx-include="#filter-form"
                    hx-indicator="#loading-indicator"
                    class="block w-full px-4 py-2 text-left text-sm transition-colors cursor-pointer"
                    :class="status === 'Completed' ? 'bg-indigo-600 text-white font-medium' : 'text-gray-300 hover:bg-[#454d5a] hover:text-white'"
                    @click="status = 'Completed'; open = false"
                    type="button">Completed</button>
            <button hx-get="{% url 'medialist' media_type %}"
                    {% if media_list %} hx-target="{{ layout_class }}" {% else %} hx-target="this" hx-swap="none" {% endif %}
                    hx-include="#filter-form"
                    hx-indicator="#loading-indicator"
                    class="block w-full px-4 py-2 text-left text-sm transition-colors cursor-pointer"
                    :class="status === 'In progress' ? 'bg-indigo-600 text-white font-medium' : 'text-gray-300 hover:bg-[#454d5a] hover:text-white'"
                    @click="status = 'In progress'; open = false"
                    type="button">In Progress</button>
            <button hx-get="{% url 'medialist' media_type %}"
                    {% if media_list %} hx-target="{{ layout_class }}" {% else %} hx-target="this" hx-swap="none" {% endif %}
                    hx-include="#filter-form"
                    hx-indicator="#loading-indicator"
                    class="block w-full px-4 py-2 text-left text-sm transition-colors cursor-pointer"
                    :class="status === 'Planning' ? 'bg-indigo-600 text-white font-medium' : 'text-gray-300 hover:bg-[#454d5a] hover:text-white'"
                    @click="status = 'Planning'; open = false"
                    type="button">Planning</button>
            <button hx-get="{% url 'medialist' media_type %}"
                    {% if media_list %} hx-target="{{ layout_class }}" {% else %} hx-target="this" hx-swap="none" {% endif %}
                    hx-include="#filter-form"
                    hx-indicator="#loading-indicator"
                    class="block w-full px-4 py-2 text-left text-sm transition-colors cursor-pointer"
                    :class="status === 'Paused' ? 'bg-indigo-600 text-white font-medium' : 'text-gray-300 hover:bg-[#454d5a] hover:text-white'"
                    @click="status = 'Paused'; open = false"
                    type="button">Paused</button>
            <button hx-get="{% url 'medialist' media_type %}"
                    {% if media_list %} hx-target="{{ layout_class }}" {% else %} hx-target="this" hx-swap="none" {% endif %}
                    hx-include="#filter-form"
                    hx-indicator="#loading-indicator"
                    class="block w-full px-4 py-2 text-left text-sm transition-colors cursor-pointer"
                    :class="status === 'Dropped' ? 'bg-indigo-600 text-white font-medium' : 'text-gray-300 hover:bg-[#454d5a] hover:text-white'"
                    @click="status = 'Dropped'; open = false"
                    type="button">Dropped</button>
            <button hx-get="{% url 'medialist' media_type %}"
                    {% if media_list %} hx-target="{{ layout_class }}" {% else %} hx-target="this" hx-swap="none" {% endif %}
                    hx-include="#filter-form"
                    hx-indicator="#loading-indicator"
                    class="block w-full px-4 py-2 text-left text-sm transition-colors cursor-pointer"
                    :class="status === 'Repeating' ? 'bg-indigo-600 text-white font-medium' : 'text-gray-300 hover:bg-[#454d5a] hover:text-white'"
                    @click="status = 'Repeating'; open = false"
                    type="button">Repeating</button>
          </div>
        </div>

        <!-- Sort by -->
        <div class="relative" x-data="{ open: false }">
          <button class="flex items-center px-4 py-2 bg-[#39404b] rounded-md hover:bg-[#454d5a] transition-colors cursor-pointer"
                  @click="open = !open"
                  type="button">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 viewBox="0 0 24 24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round"
                 class="w-4 h-4 mr-2">
              <path d="m21 16-4 4-4-4"></path>
              <path d="M17 20V4"></path>
              <path d="m3 8 4-4 4 4"></path>
              <path d="M7 4v16"></path>
            </svg>
            <span x-text="sortLabels[sort] || sort"></span>
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 viewBox="0 0 24 24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round"
                 class="w-4 h-4 ml-2">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </button>

          <div class="absolute z-10 mt-2 py-1 w-48 bg-[#39404b] rounded-md shadow-lg overflow-hidden border border-gray-700"
               x-cloak
               x-show="open"
               @click.outside="open = false"
               x-transition:enter="transition ease-out duration-100"
               x-transition:enter-start="transform opacity-0 scale-95"
               x-transition:enter-end="transform opacity-100 scale-100"
               x-transition:leave="transition ease-in duration-75"
               x-transition:leave-start="transform opacity-100 scale-100"
               x-transition:leave-end="transform opacity-0 scale-95">
            {% for value, label in sort_choices %}
              <button hx-get="{% url 'medialist' media_type %}"
                      {% if media_list %} hx-target="{{ layout_class }}" {% else %} hx-target="this" hx-swap="none" {% endif %}
                      hx-include="#filter-form"
                      hx-indicator="#loading-indicator"
                      class="block w-full px-4 py-2 text-left text-sm transition-colors cursor-pointer"
                      :class="sort === '{{ value }}' ? 'bg-indigo-600 text-white font-medium' : 'text-gray-300 hover:bg-[#454d5a] hover:text-white'"
                      @click="sort = '{{ value }}'; open = false"
                      type="button">{{ label }}</button>
            {% endfor %}
          </div>
        </div>

        <!-- Layout Toggle -->
        <div class="flex rounded-md overflow-hidden border border-gray-700">
          <a :href="`{% url 'medialist' media_type %}?${search ? 'search=' + search + '&' : ''}${status !== 'all' ? 'status=' + status + '&' : ''}${sort !== 'score' ? 'sort=' + sort + '&' : ''}layout=grid`"
             class="p-2 cursor-pointer"
             :class="layout === 'grid' ? 'bg-indigo-600 text-white' : 'bg-[#39404b] hover:bg-[#454d5a]'"
             title="Grid View"
             @click="layout = 'grid'">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 viewBox="0 0 24 24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round"
                 class="w-5 h-5">
              <rect width="7" height="7" x="3" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="14" rx="1"></rect><rect width="7" height="7" x="3" y="14" rx="1"></rect>
            </svg>
          </a>
          <a :href="`{% url 'medialist' media_type %}?${search ? 'search=' + search + '&' : ''}${status !== 'all' ? 'status=' + status + '&' : ''}${sort !== 'score' ? 'sort=' + sort + '&' : ''}layout=table`"
             class="p-2 cursor-pointer"
             :class="layout === 'table' ? 'bg-indigo-600 text-white' : 'bg-[#39404b] hover:bg-[#454d5a]'"
             title="Table View"
             @click="layout = 'table'">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 viewBox="0 0 24 24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round"
                 class="w-5 h-5">
              <path d="M12 3v18"></path>
              <rect width="18" height="18" x="3" y="3" rx="2"></rect>
              <path d="M3 9h18"></path>
              <path d="M3 15h18"></path>
            </svg>
          </a>
        </div>
      </div>
    </div>

    {% if not media_list %}
      <div class="flex flex-col items-center justify-center py-16 bg-[#2a2f35] rounded-lg">
        <div class="text-center max-w-md mx-auto p-6">
          <div class="bg-[#39404b] rounded-full p-4 w-16 h-16 mx-auto mb-4 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 viewBox="0 0 24 24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round"
                 class="w-8 h-8 text-gray-400">
              <path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z"></path>
            </svg>
          </div>
          <h3 class="text-xl font-semibold mb-2">No {{ media_type|media_type_readable_plural }} Tracked Yet</h3>
          <p class="text-gray-400 mb-6">
            Start tracking your {{ media_type_plural }} to keep a record of what you've {{ media_type|media_past_verb }}.
          </p>
          <a href="{{ media_type|sample_search }}"
             class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">
            Browse {{ media_type|media_type_readable_plural }}
          </a>
        </div>
      </div>
    {% elif current_layout == "grid" %}
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-8 gap-4">
        {% include "app/components/media_grid_items.html" %}
      </div>
    {% else %}
      <div class="bg-[#2a2f35] p-4 rounded-lg overflow-hidden max-w-[calc(100svw-4rem)] overflow-x-scroll">
        <table class="w-full bg-[#2a2f35]">
          <thead class="text-left text-gray-400 text-sm">
            <tr>
              <th class="p-2 w-15"></th>
              <th class="p-2 w-2/5">Title</th>
              <th class="p-2 text-center">Score</th>
              <th class="p-2 text-center">Progress</th>
              <th class="p-2 text-center">Status</th>
              <th class="p-2 text-center">Start Date</th>
              <th class="p-2 text-center">End Date</th>
            </tr>
          </thead>
          <tbody>
            {% include "app/components/media_table_items.html" %}
          </tbody>
        </table>
      </div>
    {% endif %}

    <div id="loading-indicator" class="htmx-indicator text-center pt-8">
      <div class="inline-flex justify-center items-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
      </div>
    </div>
  </div>
{% endblock content %}
