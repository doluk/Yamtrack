{% extends "base.html" %}
{% load app_tags %}

{% block title %}
  Home - Yamtrack
{% endblock title %}

{% block content %}
  <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-8">
    <h1 class="text-3xl font-bold text-center w-full sm:w-auto">In Progress</h1>
    <div class="relative" x-data="{ open: false }">
      <button @click="open = !open"
              @click.outside="open = false"
              class="flex items-center gap-2 px-4 py-2 bg-[#39404b] hover:bg-[#454d5a] rounded-md transition-colors cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg"
             width="24"
             height="24"
             viewBox="0 0 24 24"
             fill="none"
             stroke="currentColor"
             stroke-width="2"
             stroke-linecap="round"
             stroke-linejoin="round"
             class="w-4 h-4">
          <path d="m21 16-4 4-4-4"></path>
          <path d="M17 20V4"></path>
          <path d="m3 8 4-4 4 4"></path>
          <path d="M7 4v16"></path>
        </svg>
        <span class="text-sm font-medium">{{ current_sort|no_underscore|title }}</span>
        <svg xmlns="http://www.w3.org/2000/svg"
             width="24"
             height="24"
             viewBox="0 0 24 24"
             fill="none"
             stroke="currentColor"
             stroke-width="2"
             stroke-linecap="round"
             stroke-linejoin="round"
             class="w-4 h-4 text-gray-400">
          <path d="m6 9 6 6 6-6"></path>
        </svg>
      </button>
      <div x-show="open"
           x-transition:enter="transition ease-out duration-100"
           x-transition:enter-start="transform opacity-0 scale-95"
           x-transition:enter-end="transform opacity-100 scale-100"
           x-transition:leave="transition ease-in duration-75"
           x-transition:leave-start="transform opacity-100 scale-100"
           x-transition:leave-end="transform opacity-0 scale-95"
           class="absolute right-0 mt-2 py-1 w-48 bg-[#39404b] rounded-md shadow-lg overflow-hidden z-10 border border-gray-700">
        <a href="{% url 'home' %}?sort=upcoming"
           class="block w-full px-4 py-2 text-left text-sm transition-colors {% if current_sort == 'upcoming' %}bg-indigo-600 text-white font-medium{% else %}text-gray-300 hover:bg-[#454d5a] hover:text-white{% endif %}">
          Upcoming
        </a>
        <a href="{% url 'home' %}?sort=completion"
           class="block w-full px-4 py-2 text-left text-sm transition-colors {% if current_sort == 'completion' %}bg-indigo-600 text-white font-medium{% else %}text-gray-300 hover:bg-[#454d5a] hover:text-white{% endif %}">
          Completion
        </a>
        <a href="{% url 'home' %}?sort=episodes_left"
           class="block w-full px-4 py-2 text-left text-sm transition-colors {% if current_sort == 'episodes_left' %}bg-indigo-600 text-white font-medium{% else %}text-gray-300 hover:bg-[#454d5a] hover:text-white{% endif %}">
          Episodes Left
        </a>
        <a href="{% url 'home' %}?sort=title"
           class="block w-full px-4 py-2 text-left text-sm transition-colors {% if current_sort == 'title' %}bg-indigo-600 text-white font-medium{% else %}text-gray-300 hover:bg-[#454d5a] hover:text-white{% endif %}">
          Title
        </a>
      </div>
    </div>
  </div>
  <div class="space-y-8">
    {% for media_type, media_list in list_by_type.items %}
      <div>
        <h2 class="text-xl font-semibold mb-4">{{ media_type|media_type_readable_plural }}</h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-7 gap-4">
          {% for media in media_list %}
            <div class="bg-[#2a2f35] rounded-lg overflow-hidden shadow-lg transition-all duration-300" x-data="{ trackOpen: false, listsOpen: false, historyOpen: false }">
              <div class="relative">
                <img alt="{{ media }}"
                     class="lazyload w-full aspect-[2/3] {% if media.item.image != IMG_NONE %}object-cover{% endif %}"
                     data-src="{{ media.item.image }}"
                     src="{{ IMG_NONE }}">

                {% if media.next_episode_date %}
                  <div class="absolute top-2 left-1/2 -translate-x-1/2 flex items-center gap-1.5 bg-black/80 px-2.5 py-1.5 rounded-md shadow-md whitespace-nowrap">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         width="24"
                         height="24"
                         viewBox="0 0 24 24"
                         fill="none"
                         stroke="currentColor"
                         stroke-width="2"
                         stroke-linecap="round"
                         stroke-linejoin="round"
                         class="w-3.5 h-3.5 text-indigo-400">
                      <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span class="text-xs font-medium text-white drop-shadow-sm">
                      {% if media.next_episode_number %}Ep. {{ media.next_episode_number }} â€¢{% endif %}
                    {{ media.next_episode_date|naturalday }}</span>
                  </div>
                {% endif %}

                <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 hover-tap:opacity-100">
                  <a href="{{ media.item|media_url }}" class="absolute inset-0"></a>

                  <div class="relative flex items-center justify-center space-x-2.5">
                    {# Track Button #}
                    <button class="p-2.5 bg-indigo-600 text-white rounded-full hover:bg-indigo-500 hover:scale-110 hover:shadow-[0_0_15px_rgba(99,102,241,0.5)] transition-all duration-200 cursor-pointer"
                            hx-get="{% modal_url 'track' media.item %}"
                            hx-vals='{"return_url": "{{ request.get_full_path|urlencode }}"}'
                            hx-target="#{% component_id 'track' media.item %}"
                            hx-trigger="click once"
                            @click="trackOpen = true">
                      <svg xmlns="http://www.w3.org/2000/svg"
                           width="16"
                           height="16"
                           viewBox="0 0 24 24"
                           fill="none"
                           stroke="currentColor"
                           stroke-width="2"
                           stroke-linecap="round"
                           stroke-linejoin="round">
                        <path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z"></path>
                      </svg>
                    </button>

                    {# Lists Button #}
                    <button class="p-2.5 bg-emerald-600 text-white rounded-full hover:bg-emerald-500 hover:scale-110 hover:shadow-[0_0_15px_rgba(16,185,129,0.5)] transition-all duration-200 cursor-pointer"
                            hx-get="{% modal_url 'lists' media.item %}"
                            hx-vals='{"return_url": "{{ request.get_full_path|urlencode }}"}'
                            hx-target="#{% component_id 'lists' media.item %}"
                            hx-trigger="click once"
                            @click="listsOpen = true">
                      <svg xmlns="http://www.w3.org/2000/svg"
                           width="16"
                           height="16"
                           viewBox="0 0 24 24"
                           fill="none"
                           stroke="currentColor"
                           stroke-width="2"
                           stroke-linecap="round"
                           stroke-linejoin="round">
                        <path d="M11 12H3"></path>
                        <path d="M16 6H3"></path>
                        <path d="M16 18H3"></path>
                        <path d="M18 9v6"></path>
                        <path d="M21 12h-6"></path>
                      </svg>
                    </button>

                    {# History Button #}
                    <button class="p-2.5 bg-amber-600 text-white rounded-full hover:bg-amber-500 hover:scale-110 hover:shadow-[0_0_15px_rgba(245,158,11,0.5)] transition-all duration-200 cursor-pointer"
                            hx-get="{% modal_url 'history' media.item %}"
                            hx-vals='{"return_url": "{{ request.get_full_path|urlencode }}"}'
                            hx-target="#{% component_id 'history' media.item %}"
                            hx-trigger="click once"
                            @click="historyOpen = true">
                      <svg xmlns="http://www.w3.org/2000/svg"
                           width="16"
                           height="16"
                           viewBox="0 0 24 24"
                           fill="none"
                           stroke="currentColor"
                           stroke-width="2"
                           stroke-linecap="round"
                           stroke-linejoin="round">
                        <path d="M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3.5"></path>
                        <path d="M16 2v4"></path>
                        <path d="M8 2v4"></path>
                        <path d="M3 10h5"></path>
                        <path d="M17.5 17.5 16 16.3V14"></path>
                        <circle cx="16" cy="16" r="6"></circle>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
              <div class="p-3 space-y-3">
                <a href="{{ media.item|media_url }}"
                   class="text-sm font-semibold text-white hover:text-indigo-400 transition duration-300 line-clamp-1 text-center">{{ media }}</a>
                <div id="progress-changer-{{ media.item.id }}">
                  {% include "app/components/progress_changer.html" with media=media csrf_token=csrf_token only %}
                </div>
              </div>

              {# Track Modal #}
              <div x-show="trackOpen"
                   @keydown.escape.window="trackOpen = false"
                   class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                <div class="w-[32rem] max-h-[90vh] px-4 md:px-0 relative z-60"
                     @click.outside="trackOpen = false">
                  <div id="{% component_id 'track' media.item %}"></div>
                </div>
              </div>

              {# Lists Modal #}
              <div x-show="listsOpen"
                   @keydown.escape.window="listsOpen = false"
                   class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                <div class="w-96 max-h-[90vh] px-4 md:px-0 relative z-60"
                     @click.outside="listsOpen = false">
                  <div id="{% component_id 'lists' media.item %}"></div>
                </div>
              </div>

              {# History Modal #}
              <div x-show="historyOpen"
                   @keydown.escape.window="historyOpen = false"
                   class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                <div class="w-96 max-h-[90vh] px-4 md:px-0 relative z-60"
                     @click.outside="historyOpen = false">
                  <div id="{% component_id 'history' media.item %}"></div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% empty %}
      <div class="flex flex-col items-center justify-center py-32 px-4 bg-[#2a2f35] rounded-lg">
        <div class="bg-[#39404b] rounded-full p-4 w-16 h-16 mx-auto mb-4 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg"
               width="24"
               height="24"
               viewBox="0 0 24 24"
               fill="none"
               stroke="currentColor"
               stroke-width="2"
               stroke-linecap="round"
               stroke-linejoin="round"
               class="w-8 h-8 text-gray-400">
            <path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2" />
          </svg>
        </div>
        <h3 class="text-xl font-semibold mb-2">No media in progress</h3>
        <p class="text-gray-400 text-center max-w-md mb-4">Start tracking your progress by marking items as "In Progress".</p>
        <div class="pt-4">
          <a href="{{ 'tv'|sample_search }}"
             class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">Browse Media</a>
        </div>
      </div>
    {% endfor %}
  </div>
{% endblock content %}
