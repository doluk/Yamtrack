{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% load user_tags %}
{% load app_tags %}

{% block title %}
  Profile - Yamtrack
{% endblock title %}

{% block container %}

  <form method="post" class="mb-4">
    {% csrf_token %}
    <div class="form-group">
      <legend class="border-bottom mb-4">Profile</legend>
      {% crispy user_form %}
    </div>
  </form>

  <form method="post" class="mb-4">
    {% csrf_token %}
    <div class="form-group">
      <legend class="border-bottom mb-4">Password Update</legend>
      {% crispy password_form %}
    </div>
  </form>

  <form method="post" class="mb-4">
    {% csrf_token %}
    <div class="form-group">
      <legend class="border-bottom mb-4">Media Tracking Preferences</legend>
      <div class="form-switch d-flex justify-content-between border rounded-2 px-3 py-2 mb-3">
        <label class="form-check-label">
          <i class="bi bi-search me-2"></i> Hide disabled media types from search
        </label>

        <input class="form-check-input"
               type="checkbox"
               name="hide_disabled"
               value="true"
               {% if request.user.hide_from_search %}checked{% endif %}>
      </div>

      <hr class="my-4" />

      {% for media_type in media_types %}
        <div class="form-switch d-flex justify-content-between border rounded-2 px-3 py-2 mb-3">
          <label class="form-check-label">
            <i class="{{ media_type|icon }} me-2"></i>
            {% if media_type == "tv" %}
              TV Show
            {% else %}
              {{ media_type|title }}
            {% endif %}
          </label>

          {% with enabled_field=media_type|add:"_enabled" %}
            <input class="form-check-input"
                   type="checkbox"
                   name="media_types_checkboxes"
                   value="{{ media_type }}"
                   {% if user|get_attr:enabled_field %}checked{% endif %}>
          {% endwith %}
        </div>
      {% endfor %}

      <div class="mb-3">
        <button type="submit" class="btn btn-secondary">Update</button>
      </div>
    </div>
  </form>

  <div class="mb-4">
    <legend class="border-bottom mb-4">Integrations</legend>

    <div class="mb-3">
      <label class="form-label" for="token-input">Token</label>
      <div class="input-group">
        <input type="text"
               class="form-control"
               id="token-input"
               value="{{ request.user.token|default_if_none:"" }}"
               readonly
               role="button">

        <button class="btn btn-secondary"
                type="button"
                id="copyButton"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="Copy to clipboard">
          <i class="bi bi-clipboard"></i>
        </button>

        <button class="btn btn-danger"
                type="button"
                data-bs-toggle="modal"
                data-bs-target="#confirmModal">
          <i class="bi bi-arrow-repeat"></i>
        </button>
      </div>
    </div>

    <div>
      <label class="form-label">Jellyfin</label>

      <div class="card">
        <div class="card-body">
          <ol>
            <li>You will need to have TMDB and TVDB as metadata providers in Jellyfin.</li>
            <li>Generate a token above if you don't have one yet.</li>
            <li>
              Add this repository <a href="https://raw.githubusercontent.com/shemanaev/jellyfin-plugin-repo/master/manifest.json">link</a> to your "Plugins Catalog" in Jellyfin settings.
            </li>
            <li>
              In Jellyfin settings, go to "My Plugins" and install the <a href="https://github.com/shemanaev/jellyfin-plugin-webhooks">Unofficial Webhooks plugin</a>.
            </li>
            <li>
              In the Webhooks plugin settings:
              <ul>
                <li>
                  URL: <a href="{{ request.scheme }}://{{ request.get_host }}/webhook/jellyfin/{{ request.user.token|default_if_none:"&lttoken&gt" }}">{{ request.scheme }}://{{ request.get_host }}/webhook/jellyfin/{{ request.user.token|default_if_none:"&lttoken&gt" }}</a>
                </li>
                <li>Payload format: Default</li>
                <li>Listen to events only for: Your Jellyfin User</li>
                <li>
                  Events: <code>Stop</code>, <code>MarkPlayed</code> and <code>MarkUnplayed</code>
                </li>
              </ul>
            </li>
          </ol>
        </div>
      </div>
    </div>

  </div>

  <!-- Modal -->
  <div class="modal fade"
       id="confirmModal"
       tabindex="-1"
       aria-labelledby="confirmModalLabel"
       aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">Regenerate Token?</h5>
          <button type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body">
          This action will invalidate your current token. All applications using this token will need to be updated.
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <form method="post" action="{% url 'regenerate_token' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary">Continue</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="mb-4"
       x-data="{ frequency: 'once', importTime: '{% now "H:i" %}', importMode: 'new' }">

    <legend class="border-bottom mb-4">Import Media</legend>

    <div class="card">
      <div class="card-body">
        <div class="row row-gap-4">
          <div class="col-md-6">
            <label class="form-label">
              <i class="bi bi-calendar me-2"></i>Import Frequency
            </label>
            <select class="form-select" x-model="frequency">
              <option value="once">One-time Import</option>
              <option value="daily">Daily</option>
              <option value="every_2_days">Every 2 days</option>
            </select>

            <div x-show="frequency !== 'once'" x-cloak class="mt-3">
              <label class="form-label">
                <i class="bi bi-clock me-2"></i> Import Time
              </label>
              <input type="time" class="form-control" x-model="importTime">
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">
              <i class="bi bi-arrow-repeat me-2"></i> Import Mode
            </label>
            <select class="form-select" x-model="importMode">
              <option value="new">Only sync new items</option>
              <option value="overwrite">Sync new items and overwrite existing</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <hr class="my-4" />

    <template x-if="frequency !== 'once'">
      <div class="alert alert-info mb-3">
        <i class="bi bi-info-circle me-2"></i>
        File uploads and OAuth-based imports are only available for one-time imports
      </div>
    </template>

    <!-- Trakt -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-column justify-content-between">
        <div class="d-flex flex-column flex-lg-row flex-wrap justify-content-between align-items-lg-center row-gap-4">
          <div class="d-flex gap-3 flex-wrap">
            <img src="https://trakt.tv/assets/logos/logomark.square.gradient-b644b16c38ff775861b4b1f58c1230f6a097a2466ab33ae00445a505c33fcb91.svg"
                 alt="Trakt logo"
                 class="rounded"
                 width="58"
                 height="58">
            <div>
              <h5 class="card-title mb-1">Trakt</h5>
              <p class="text-muted mb-0">Import TV shows, movies and anime</p>
            </div>
          </div>

          <form class="d-flex" method="post" action="{% url 'import_trakt' %}">
            {% csrf_token %}
            <input type="hidden" name="frequency" x-model="frequency">
            <input type="hidden" name="time" x-model="importTime">
            <input type="hidden" name="mode" x-model="importMode">
            <span class="badge"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  title="Found at your Trakt profile URL">
              <i class="bi bi-question-circle"></i>
            </span>
            <input type="text"
                   class="form-control border-end-0 rounded-end-0"
                   name="trakt"
                   placeholder="Trakt Username Slug">
            <button class="btn btn-secondary border-start-0 rounded-start-0">
              <i class="bi bi-cloud-download"></i>
            </button>
          </form>
        </div>

        {% include "users/components/import_status.html" with import_task=import_tasks.trakt source="trakt" %}
      </div>
    </div>

    <!-- SIMKL -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-column justify-content-between">
        <div class="d-flex flex-column flex-lg-row flex-wrap justify-content-between align-items-lg-center row-gap-4">
          <div class="d-flex gap-3 flex-wrap">
            <img src="https://eu.simkl.in/img_favicon/v2/favicon-192x192.png"
                 alt="SIMKL logo"
                 class="rounded"
                 width="58"
                 height="58">
            <div>
              <h5 class="card-title mb-1">SIMKL</h5>
              <p class="text-muted mb-0">Import TV shows, movies and anime</p>
            </div>
          </div>

          <form method="post"
                action="{% url 'simkl_oauth' %}"
                :class="{ 'opacity-50': frequency !== 'once' }">
            {% csrf_token %}
            <input type="hidden" name="mode" x-model="importMode">
            <button class="btn btn-secondary" :disabled="frequency !== 'once'">
              <i class="bi bi-box-arrow-in-right me-2"></i>Authenticate
            </button>
          </form>
        </div>

        {% include "users/components/import_status.html" with import_task=import_tasks.simkl source="simkl" %}
      </div>
    </div>

    <!-- MyAnimeList -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-column justify-content-between">
        <div class="d-flex flex-column flex-lg-row flex-wrap justify-content-between align-items-lg-center row-gap-4">
          <div class="d-flex gap-3 flex-wrap">
            <img src="https://cdn.myanimelist.net/img/sp/icon/apple-touch-icon-256.png"
                 alt="MyAnimeList logo"
                 class="rounded"
                 width="58"
                 height="58">
            <div>
              <h5 class="card-title mb-1">MyAnimeList</h5>
              <p class="text-muted mb-0">Import anime and manga</p>
            </div>
          </div>

          <form class="d-flex" method="post" action="{% url 'import_mal' %}">
            {% csrf_token %}
            <input type="hidden" name="frequency" x-model="frequency">
            <input type="hidden" name="time" x-model="importTime">
            <input type="hidden" name="mode" x-model="importMode">
            <input type="text"
                   class="form-control border-end-0 rounded-end-0"
                   name="mal"
                   placeholder="MAL Username">
            <button class="btn btn-secondary border-start-0 rounded-start-0">
              <i class="bi bi-cloud-download"></i>
            </button>
          </form>
        </div>

        {% include "users/components/import_status.html" with import_task=import_tasks.myanimelist source="myanimelist" %}
      </div>
    </div>

    <!-- AniList -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-column justify-content-between">
        <div class="d-flex flex-column flex-lg-row flex-wrap justify-content-between align-items-lg-center row-gap-4">
          <div class="d-flex gap-3 flex-wrap">
            <img src="https://anilist.co/img/icons/icon.svg"
                 alt="AniList logo"
                 class="rounded"
                 width="58"
                 height="58">
            <div>
              <h5 class="card-title mb-1">AniList</h5>
              <p class="text-muted mb-0">Import anime and manga</p>
            </div>
          </div>

          <form class="d-flex" method="post" action="{% url 'import_anilist' %}">
            {% csrf_token %}
            <input type="hidden" name="frequency" x-model="frequency">
            <input type="hidden" name="time" x-model="importTime">
            <input type="hidden" name="mode" x-model="importMode">
            <input type="text"
                   class="form-control border-end-0 rounded-end-0"
                   name="anilist"
                   placeholder="AniList Username">
            <button class="btn btn-secondary border-start-0 rounded-start-0">
              <i class="bi bi-cloud-download"></i>
            </button>
          </form>
        </div>

        {% include "users/components/import_status.html" with import_task=import_tasks.anilist source="anilist" %}
      </div>
    </div>

    <!-- Kitsu -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-column justify-content-between">
        <div class="d-flex flex-column flex-lg-row flex-wrap justify-content-between align-items-lg-center row-gap-4">
          <div class="d-flex gap-3 flex-wrap">
            <img src="https://kitsu.app/favicon-194x194-2f4dbec5ffe82b8f61a3c6d28a77bc6e.png"
                 alt="Kitsu logo"
                 class="rounded"
                 width="58"
                 height="58">
            <div>
              <h5 class="card-title mb-1">Kitsu</h5>
              <p class="text-muted mb-0">Import anime and manga</p>
            </div>
          </div>

          <form class="d-flex" method="post" action="{% url 'import_kitsu' %}">
            {% csrf_token %}
            <input type="hidden" name="frequency" x-model="frequency">
            <input type="hidden" name="time" x-model="importTime">
            <input type="hidden" name="mode" x-model="importMode">
            <span class="badge"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  title="Found at your Kitsu profile URL">
              <i class="bi bi-question-circle"></i>
            </span>
            <input type="text"
                   class="form-control border-end-0 rounded-end-0"
                   name="kitsu"
                   placeholder="Kitsu ID">
            <button class="btn btn-secondary border-start-0 rounded-start-0">
              <i class="bi bi-cloud-download"></i>
            </button>
          </form>
        </div>

        {% include "users/components/import_status.html" with import_task=import_tasks.kitsu source="kitsu" %}
      </div>
    </div>

    <!-- YamTrack CSV -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-column justify-content-between">
        <div class="d-flex flex-column flex-lg-row flex-wrap justify-content-between align-items-lg-center row-gap-4">
          <div class="d-flex gap-3 flex-wrap">
            <img src="{% static "favicon/apple-touch-icon.png" %}"
                 alt="Kitsu logo"
                 class="rounded"
                 width="58"
                 height="58">
            <div>
              <h5 class="card-title mb-1">YamTrack CSV</h5>
              <p class="text-muted mb-0">Import from YamTrack backup</p>
            </div>
          </div>

          <form class="d-flex"
                method="post"
                enctype="multipart/form-data"
                action="{% url 'import_yamtrack' %}"
                :class="{ 'opacity-50': frequency !== 'once' }">
            {% csrf_token %}
            <input type="hidden" name="mode" x-model="importMode">
            <input type="file"
                   accept=".csv"
                   class="form-control rounded-end-0"
                   name="yamtrack_csv"
                   :disabled="frequency !== 'once'">
            <button class="btn btn-secondary border-start-0 rounded-start-0"
                    :disabled="frequency !== 'once'">
              <i class="bi bi-file-earmark-arrow-up"></i>
            </button>
          </form>
        </div>

        {% include "users/components/import_status.html" with import_task=import_tasks.yamtrack source="yamtrack" %}
      </div>
    </div>
  </div>

  <div class="mb-4">
    <legend class="border-bottom mb-4">Export Media</legend>

    <div class="card mb-3">
      <div class="card-body d-flex flex-column justify-content-between">
        <div class="d-flex flex-column flex-lg-row flex-wrap justify-content-between align-items-lg-center row-gap-4">
          <div class="d-flex gap-3 flex-wrap">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="58"
                 height="58"
                 fill="currentColor"
                 class="bi bi-filetype-csv"
                 viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M14 4.5V14a2 2 0 0 1-2 2h-1v-1h1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5zM3.517 14.841a1.13 1.13 0 0 0 .401.823q.195.162.478.252.284.091.665.091.507 0 .859-.158.354-.158.539-.44.187-.284.187-.656 0-.336-.134-.56a1 1 0 0 0-.375-.357 2 2 0 0 0-.566-.21l-.621-.144a1 1 0 0 1-.404-.176.37.37 0 0 1-.144-.299q0-.234.185-.384.188-.152.512-.152.214 0 .37.068a.6.6 0 0 1 .246.181.56.56 0 0 1 .12.258h.75a1.1 1.1 0 0 0-.2-.566 1.2 1.2 0 0 0-.5-.41 1.8 1.8 0 0 0-.78-.152q-.439 0-.776.15-.337.149-.527.421-.19.273-.19.639 0 .302.122.524.124.223.352.367.228.143.539.213l.618.144q.31.073.463.193a.39.39 0 0 1 .152.326.5.5 0 0 1-.085.29.56.56 0 0 1-.255.193q-.167.07-.413.07-.175 0-.32-.04a.8.8 0 0 1-.248-.115.58.58 0 0 1-.255-.384zM.806 13.693q0-.373.102-.633a.87.87 0 0 1 .302-.399.8.8 0 0 1 .475-.137q.225 0 .398.097a.7.7 0 0 1 .272.26.85.85 0 0 1 .12.381h.765v-.072a1.33 1.33 0 0 0-.466-.964 1.4 1.4 0 0 0-.489-.272 1.8 1.8 0 0 0-.606-.097q-.534 0-.911.223-.375.222-.572.632-.195.41-.196.979v.498q0 .568.193.976.197.407.572.626.375.217.914.217.439 0 .785-.164t.55-.454a1.27 1.27 0 0 0 .226-.674v-.076h-.764a.8.8 0 0 1-.118.363.7.7 0 0 1-.272.25.9.9 0 0 1-.401.087.85.85 0 0 1-.478-.132.83.83 0 0 1-.299-.392 1.7 1.7 0 0 1-.102-.627zm8.239 2.238h-.953l-1.338-3.999h.917l.896 3.138h.038l.888-3.138h.879z" />
            </svg>
            <div>
              <h5 class="card-title mb-1">Export Data</h5>
              <p class="text-muted mb-0">Download all your media data in CSV format</p>
            </div>
          </div>

          <form class="d-flex" method="get" action="{% url 'export_csv' %}">
            <button class="btn btn-secondary">
              <i class="bi bi-download me-2"></i> Download
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="mb-4">
    <legend class="border-bottom mb-4">Other</legend>

    <div class="input-group profile-grid">
      <form class="p-2" method="post" action="{% url 'reload_calendar' %}">
        {% csrf_token %}
        <button class="btn btn-secondary w-100" type="submit">Reload Calendar</button>
      </form>
    </div>
  </div>

{% endblock container %}

{% block js %}
  <script src="{% static 'js/copy-token.js' %}"></script>

  {% comment %} Enable bootstrap tooltips {% endcomment %}
  <script>
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
  </script>

{% endblock js %}
